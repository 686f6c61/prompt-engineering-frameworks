{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <h1 class="display-4 text-center mb-5">Ayuda y preguntas frecuentes</h1>
    
    <div class="row mb-5">
        <div class="col-lg-8 mx-auto">
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <i class="bi bi-info-circle-fill me-2 fs-4"></i>
                    <div>
                        <strong>Soporte técnico:</strong> Si no encuentras respuesta a tu pregunta, utiliza el formulario de contacto al final de esta página.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sección de FAQ -->
    <div class="row mb-5">
        <div class="col-lg-10 mx-auto">
            <div class="accordion" id="accordionFAQ">
                <!-- Grupo 1: Preguntas sobre versión gratuita -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            <i class="bi bi-patch-check text-success me-2"></i> Versión Gratuita
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionFAQ">
                        <div class="accordion-body">
                            <div class="mb-4">
                                <h5>¿Qué limitaciones tiene la versión gratuita?</h5>
                                <p>La versión gratuita utiliza el modelo GPT-3.5 Turbo y está limitada a 10 solicitudes por hora por usuario. Esta versión es perfecta para usuarios ocasionales que quieren mejorar sus prompts sin necesidad de una API key propia.</p>
                            </div>
                            
                            <div class="mb-4">
                                <h5>¿Necesito crear una cuenta para usar la versión gratuita?</h5>
                                <p>No, Prompt Agent no requiere registro ni creación de cuenta para la versión gratuita. Simplemente accede a la web y comienza a generar prompts estructurados inmediatamente.</p>
                            </div>
                            
                            <div>
                                <h5>¿Cómo se cuentan las 10 solicitudes por hora?</h5>
                                <p>Cada vez que generas un prompt completo o solicitas una recomendación de framework, se cuenta como una solicitud. El contador se reinicia automáticamente cada hora. Puedes ver tu uso actual en la interfaz de la aplicación.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Grupo 2: Preguntas sobre o4-mini -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTwo">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            <i class="bi bi-stars text-warning me-2"></i> Modelo Premium (o4-mini)
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionFAQ">
                        <div class="accordion-body">
                            <div class="mb-4">
                                <h5>¿Qué ventajas ofrece el modelo o4-mini?</h5>
                                <p>El modelo premium o4-mini-2025-04-16 ofrece una calidad superior en la generación de prompts, con mayor precisión, contexto y creatividad. Además, al usar tu propia API key, no tienes limitaciones en el número de solicitudes que puedes realizar por hora.</p>
                            </div>
                            
                            <div class="mb-4">
                                <h5>¿Cómo puedo acceder al modelo premium?</h5>
                                <p>Para utilizar el modelo premium, necesitas configurar tu propia API key de OpenAI. Ve a la sección de "Configuración" en el menú principal, selecciona la opción "Usar API key personal" e introduce tu clave. Esta configuración se guarda en tu navegador durante 30 días.</p>
                            </div>
                            
                            <div>
                                <h5>¿Puedo alternar entre la versión gratuita y premium?</h5>
                                <p>Sí, puedes cambiar entre ambos modelos en cualquier momento desde la sección de "Configuración". Si decides volver a la versión gratuita, simplemente selecciona esa opción y tu API key se eliminará de la sesión.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Grupo 3: Preguntas sobre privacidad de API key -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingThree">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                            <i class="bi bi-shield-lock text-primary me-2"></i> Privacidad de API Key
                        </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionFAQ">
                        <div class="accordion-body">
                            <div class="mb-4">
                                <h5>¿Es seguro proporcionar mi API key?</h5>
                                <p>Tu API key se almacena exclusivamente en la sesión de tu navegador mediante cookies cifradas y nunca se envía a nuestros servidores. Prompt Agent utiliza un enfoque de "client-side" para manejar las solicitudes a la API de OpenAI directamente desde tu navegador.</p>
                            </div>
                            
                            <div class="mb-4">
                                <h5>¿Por qué no pueden acceder a mi API key aunque la introduzca en la aplicación?</h5>
                                <p><strong>Explicación técnica:</strong> Utilizamos un patrón de arquitectura que separa completamente el manejo de la API key del servidor. Cuando introduces tu clave, esta se almacena mediante <code>sessionStorage</code> en tu navegador y se cifra con una clave generada localmente. Las solicitudes a OpenAI se realizan directamente desde tu navegador mediante peticiones CORS, sin pasar por nuestros servidores. Además, implementamos una política de Content Security Policy (CSP) estricta que impide cualquier filtración de datos a dominios no autorizados.</p>
                            </div>
                            
                            <div>
                                <h5>¿Dónde se guardan mis prompts generados?</h5>
                                <p>Los prompts generados se procesan localmente en tu navegador y no se almacenan en nuestros servidores. Toda la información generada permanece en tu dispositivo a menos que decidas exportarla manualmente. Nuestro sistema está diseñado para maximizar la privacidad y seguridad de tus datos.</p>
                            </div>
                            
                            <div>
                                <h5>¿Dónde está alojada la aplicación y sus datos?</h5>
                                <p>Prompt Agent está alojado en la plataforma Render, cuyos servidores para aplicaciones web se encuentran ubicados en Irlanda, dentro del territorio de la Unión Europea. Esto garantiza que cualquier procesamiento de datos se realiza conforme al RGPD y otras normativas europeas de protección de datos, sin transferencias internacionales fuera del Espacio Económico Europeo.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Grupo 4: Preguntas sobre frameworks -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFour">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                            <i class="bi bi-grid-3x3-gap text-danger me-2"></i> Frameworks
                        </button>
                    </h2>
                    <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#accordionFAQ">
                        <div class="accordion-body">
                            <div class="mb-4">
                                <h5>¿Cómo se seleccionan los frameworks para mi objetivo?</h5>
                                <p>Prompt Agent analiza tu objetivo utilizando algoritmos de procesamiento de lenguaje natural para identificar patrones, intenciones y contexto. Basándose en este análisis, el sistema selecciona el framework más adecuado de nuestra biblioteca de 47+ frameworks especializados para diferentes tipos de tareas.</p>
                            </div>
                            
                            <div class="mb-4">
                                <h5>¿Puedo combinar varios frameworks en un solo prompt?</h5>
                                <p>Actualmente, Prompt Agent está optimizado para utilizar un framework a la vez, seleccionando el más adecuado para tu objetivo específico. Esto garantiza resultados más precisos y coherentes. En futuras actualizaciones, exploraremos la posibilidad de combinar frameworks para casos de uso más complejos.</p>
                            </div>
                            
                            <div>
                                <h5>¿Puedo descargar todos los frameworks para estudiarlos?</h5>
                                <p>Sí, ofrecemos la opción de descargar la colección completa de frameworks en formato ZIP desde la sección "¿Cómo funciona?". Esto te permite estudiar cada estructura en detalle y aplicarlas manualmente si lo prefieres.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grupo 5: Preguntas generales -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFive">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                            <i class="bi bi-question-circle text-success me-2"></i> Preguntas generales
                        </button>
                    </h2>
                    <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="#accordionFAQ">
                        <div class="accordion-body">
                            <div class="mb-4">
                                <h5>¿Prompt Agent es realmente gratuito? ¿Hay algún tipo de publicidad o planes premium?</h5>
                                <p>Sí, Prompt Agent es completamente gratuito. No tenemos planes de pago, no incluimos publicidad en la plataforma y el proyecto tiene un propósito educativo y de divulgación, sin objetivos comerciales. El servicio se ofrece tal cual, sin costes ocultos ni intención de monetización futura.</p>
                            </div>
                            
                            <div class="mb-4">
                                <h5>¿Cómo funciona el generador Bolt/Lovable?</h5>
                                <p>El generador Bolt/Lovable es una herramienta especializada para crear documentación técnica y especificaciones para proyectos web. Utiliza frameworks optimizados para plataformas de desarrollo como Bolt y Lovable, generando prompts detallados que incluyen contexto del proyecto, requisitos técnicos, estructura de componentes y estrategias de implementación.</p>
                            </div>
                            
                            <div class="mb-4">
                                <h5>¿Con qué frecuencia se añaden nuevos frameworks?</h5>
                                <p>Actualizamos nuestra biblioteca de frameworks regularmente, añadiendo nuevas estructuras a medida que evolucionan las mejores prácticas en prompt engineering. Realizamos actualizaciones aproximadamente cada 2-3 meses, pero también incorporamos frameworks específicos cuando identificamos necesidades emergentes.</p>
                            </div>
                            
                            <div>
                                <h5>¿Puedo sugerir un nuevo framework para incluir?</h5>
                                <p>¡Absolutamente! Valoramos las contribuciones de la comunidad. Puedes sugerir nuevos frameworks utilizando el formulario de contacto al final de esta página, o a través de nuestro repositorio de GitHub si prefieres un enfoque más técnico.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Formulario de contacto -->
    <div class="row mt-5 pt-4">
        <div class="col-lg-8 mx-auto">
            <!-- Información sobre aumento de límite gratuito -->
            <div class="alert alert-info mb-4 border-0 shadow-sm">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 me-3">
                        <i class="bi bi-speedometer2 text-primary" style="font-size: 2rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="alert-heading mb-1">
                            <i class="bi bi-stars me-1"></i> ¿Necesitas más solicitudes gratuitas?
                        </h5>
                        <p class="mb-1">Si estás trabajando en un proyecto educativo o de investigación y necesitas aumentar el límite gratuito de 10 a 30 solicitudes por hora, explícanos tu caso utilizando el formulario de contacto a continuación.</p>
                        <hr class="my-2">
                        <p class="mb-0 small">
                            <i class="bi bi-info-circle me-1"></i> Menciona "Solicitud de código promocional" en el asunto e incluye detalles sobre tu proyecto.
                        </p>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h2 class="h4 mb-4 text-center">Formulario de contacto</h2>
                    
                    <form id="contactForm" class="needs-validation" novalidate>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="nombre" class="form-label">Nombre</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                                    <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Tu nombre" required>
                                </div>
                                <div class="invalid-feedback">
                                    Por favor introduce tu nombre
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                    <input type="email" class="form-control" id="email" name="email" placeholder="tu@email.com" required>
                                </div>
                                <div class="invalid-feedback">
                                    Por favor introduce un email válido
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="asunto" class="form-label">Asunto</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-chat-square-text"></i></span>
                                    <select class="form-select" id="asunto" name="asunto" required>
                                        <option value="" selected disabled>Selecciona</option>
                                        <option value="Solicitud de código promocional">Código promocional</option>
                                        <option value="Consulta general">Consulta</option>
                                        <option value="Sugerencia">Sugerencia</option>
                                        <option value="Reporte de error">Error</option>
                                        <option value="Propuesta de nuevo framework">Nuevo framework</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                                <div class="invalid-feedback">
                                    Por favor selecciona el asunto
                                </div>
                            </div>
                            <div class="col-12" id="otroAsuntoContainer" style="display: none;">
                                <label for="otroAsunto" class="form-label">Especifica el asunto</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-pencil"></i></span>
                                    <input type="text" class="form-control" id="otroAsunto" name="otroAsunto" placeholder="Especifica el asunto de tu mensaje">
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="mensaje" class="form-label">Mensaje</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-chat-dots"></i></span>
                                    <textarea class="form-control" id="mensaje" name="mensaje" rows="5" placeholder="Escribe tu mensaje aquí..." required></textarea>
                                </div>
                                <div class="invalid-feedback">
                                    Por favor introduce tu mensaje
                                </div>
                            </div>
                            
                            <!-- Captcha ofuscado contra bots -->
                            <div class="col-12 mt-3">
                                <label class="form-label mb-2">Verificación de seguridad <small class="text-muted">(protección anti-spam)</small></label>
                                <div class="row g-0 align-items-center">
                                    <div class="col-auto">
                                        <div class="bg-light px-3 py-2 rounded-start d-flex align-items-center captcha-question" id="captchaQuestion" style="height: 38px; user-select: none;">
                                            <span class="captcha-text">Resuelve: </span>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-4">
                                        <input type="text" class="form-control rounded-start-0" id="captchaAnswer" placeholder="Respuesta" required autocomplete="off">
                                    </div>
                                    <div class="col-auto ps-2">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshCaptcha" title="Generar nuevo captcha">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback">
                                        Respuesta incorrecta, inténtalo de nuevo
                                    </div>
                                </div>
                                <small class="text-muted" id="captchaInstruccion"></small>
                            </div>
                            
                            <div class="col-12 mt-4">
                                <div class="d-flex justify-content-center">
                                    <button type="submit" class="btn btn-primary px-5">
                                        <i class="bi bi-send me-2"></i>Enviar mensaje
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Mensaje de éxito (oculto por defecto) -->
                    <div class="alert alert-success mt-4 d-none" id="mensajeExito">
                        <i class="bi bi-check-circle me-2"></i>
                        Tu mensaje ha sido enviado correctamente. Te responderemos lo antes posible.
                    </div>
                    
                    <!-- Mensaje de error (oculto por defecto) -->
                    <div class="alert alert-danger mt-4 d-none" id="mensajeError">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Ha ocurrido un error al enviar el mensaje. Por favor intenta nuevamente más tarde.
                    </div>
                    
                    <!-- Nota sobre privacidad de datos -->
                    <div class="mt-4 pt-2 small text-muted">
                        <p><i class="bi bi-info-circle me-1"></i> <strong>Nota sobre privacidad:</strong> Los datos proporcionados en este formulario son procesados mediante Resend (un servicio de correo electrónico) y solo son utilizados para responder a su consulta. No almacenamos permanentemente esta información. Para más detalles, consulte nuestra <a href="/terminos#privacidad">política de privacidad</a>.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Generar captcha aleatorio
    function generarCaptcha() {
        // Diferentes tipos de captcha
        const captchaTypes = [
            'suma', 'resta', 'multiplicacion', 'palabra', 'secuencia', 'texto'
        ];
        
        // Elegir aleatoriamente el tipo de captcha
        const captchaType = captchaTypes[Math.floor(Math.random() * captchaTypes.length)];
        let instruccion = '';
        let correctAnswer;
        let captchaDisplay = '';
        
        // Generar captcha según el tipo
        switch(captchaType) {
            case 'suma':
                const num1Suma = Math.floor(Math.random() * 20) + 10; // 10-30
                const num2Suma = Math.floor(Math.random() * 15) + 5;  // 5-20
                correctAnswer = num1Suma + num2Suma;
                // Ofuscar un poco el display
                captchaDisplay = `${obfuscarNumero(num1Suma)} + ${obfuscarNumero(num2Suma)}`;
                instruccion = "Calcula la suma";
                break;
                
            case 'resta':
                const num1Resta = Math.floor(Math.random() * 30) + 30; // 30-60
                const num2Resta = Math.floor(Math.random() * 20) + 5;  // 5-25
                correctAnswer = num1Resta - num2Resta;
                captchaDisplay = `${obfuscarNumero(num1Resta)} - ${obfuscarNumero(num2Resta)}`;
                instruccion = "Calcula la resta";
                break;
                
            case 'multiplicacion':
                const num1Mult = Math.floor(Math.random() * 8) + 2;  // 2-10
                const num2Mult = Math.floor(Math.random() * 5) + 2;  // 2-7
                correctAnswer = num1Mult * num2Mult;
                captchaDisplay = `${obfuscarNumero(num1Mult)} × ${obfuscarNumero(num2Mult)}`;
                instruccion = "Calcula la multiplicación";
                break;
                
            case 'palabra':
                // Palabras simples invertidas
                const palabras = ['casa', 'mesa', 'libro', 'reloj', 'campo', 'cifra', 'mundo', 'clave', 'pista', 'forma'];
                const palabraSeleccionada = palabras[Math.floor(Math.random() * palabras.length)];
                const palabraInvertida = palabraSeleccionada.split('').reverse().join('');
                
                captchaDisplay = `${palabraInvertida}`;
                correctAnswer = palabraSeleccionada;
                instruccion = "Escribe esta palabra al revés";
                break;
                
            case 'secuencia':
                // Secuencia de números
                const inicioSecuencia = Math.floor(Math.random() * 5) + 1; // 1-6
                const incremento = Math.floor(Math.random() * 3) + 1;     // 1-4
                const secuencia = [
                    inicioSecuencia,
                    inicioSecuencia + incremento,
                    inicioSecuencia + (incremento * 2),
                    inicioSecuencia + (incremento * 3)
                ];
                const siguienteNumero = inicioSecuencia + (incremento * 4);
                
                captchaDisplay = `${secuencia.join(', ')}, ?`;
                correctAnswer = siguienteNumero.toString();
                instruccion = "¿Cuál es el siguiente número en la secuencia?";
                break;
                
            case 'texto':
                // Contar letras en una palabra
                const palabrasContar = ['programación', 'algoritmo', 'desarrollo', 'estructura', 'aplicación', 'captcha', 'seguridad', 'prompt'];
                const palabraParaContar = palabrasContar[Math.floor(Math.random() * palabrasContar.length)];
                const letraBuscada = palabraParaContar[Math.floor(Math.random() * palabraParaContar.length)];
                
                // Contar ocurrencias
                let conteo = 0;
                for(let i = 0; i < palabraParaContar.length; i++) {
                    if(palabraParaContar[i] === letraBuscada) {
                        conteo++;
                    }
                }
                
                captchaDisplay = `"${palabraParaContar}" → letra "${letraBuscada}"`;
                correctAnswer = conteo.toString();
                instruccion = "Cuenta cuántas veces aparece la letra indicada";
                break;
        }
        
        // Actualizar display
        const captchaElement = document.getElementById('captchaQuestion');
        captchaElement.innerHTML = `<span class="captcha-text">Resuelve: </span><span class="challenge">${captchaDisplay}</span>`;
        document.getElementById('captchaInstruccion').textContent = instruccion;
        
        // Guardar la respuesta correcta y el tipo
        captchaElement.dataset.correctAnswer = correctAnswer.toString();
        captchaElement.dataset.captchaType = captchaType;
    }
    
    // Función para ofuscar números (para dificultar scraping)
    function obfuscarNumero(num) {
        // Convertir a string y añadir espacios invisibles o entidades unicode
        const numStr = num.toString();
        let resultado = '';
        
        for (let i = 0; i < numStr.length; i++) {
            resultado += numStr[i];
            // Añadir caracteres invisibles entre dígitos
            if (i < numStr.length - 1) {
                // Agregar un espacio de ancho cero ocasionalmente
                if (Math.random() > 0.5) {
                    resultado += '&#8203;';
                }
            }
        }
        
        return resultado;
    }
    
    // Generar captcha al cargar la página
    generarCaptcha();
    
    // Botón de refrescar captcha
    document.getElementById('refreshCaptcha').addEventListener('click', function() {
        generarCaptcha();
        document.getElementById('captchaAnswer').value = '';
        document.getElementById('captchaAnswer').classList.remove('is-invalid');
    });
    
    // Validación del formulario
    const form = document.getElementById('contactForm');
    
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        
        // Verificar captcha
        const captchaAnswer = document.getElementById('captchaAnswer').value.trim().toLowerCase();
        const correctAnswer = document.getElementById('captchaQuestion').dataset.correctAnswer.toLowerCase();
        const captchaType = document.getElementById('captchaQuestion').dataset.captchaType;
        
        // Para mayor seguridad, comprobar específicamente según el tipo
        let isValid = false;
        
        if (captchaType === 'palabra') {
            // Para palabras, verificar que coincidan exactamente (ignorando mayúsculas/minúsculas)
            isValid = captchaAnswer === correctAnswer;
        } else if (['suma', 'resta', 'multiplicacion', 'secuencia', 'texto'].includes(captchaType)) {
            // Para operaciones numéricas, verificar el valor como número
            isValid = parseInt(captchaAnswer) === parseInt(correctAnswer);
        } else {
            // Fallback para otros tipos
            isValid = captchaAnswer === correctAnswer;
        }
        
        if (!isValid) {
            document.getElementById('captchaAnswer').classList.add('is-invalid');
            return;
        }
        
        // Validar el resto del formulario
        if (!form.checkValidity()) {
            event.stopPropagation();
            form.classList.add('was-validated');
            return;
        }
        
        // Si todo es válido, procesar el formulario
        const formData = {
            nombre: document.getElementById('nombre').value,
            email: document.getElementById('email').value,
            asunto: document.getElementById('asunto').value === 'Otro' ? document.getElementById('otroAsunto').value : document.getElementById('asunto').value,
            mensaje: document.getElementById('mensaje').value
        };
        
        // Deshabilitar el botón de envío y mostrar indicador de carga
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...';
        
        // Ocultar mensajes previos
        document.getElementById('mensajeExito').classList.add('d-none');
        document.getElementById('mensajeError').classList.add('d-none');
        
        // Enviar datos al endpoint
        fetch('/api/enviar-correo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar mensaje de éxito
                document.getElementById('mensajeExito').textContent = data.message || 'Tu mensaje ha sido enviado correctamente. Te responderemos lo antes posible.';
                document.getElementById('mensajeExito').classList.remove('d-none');
                
                // Reiniciar formulario
                form.reset();
                form.classList.remove('was-validated');
                
                // Generar nuevo captcha
                generarCaptcha();
                document.getElementById('captchaAnswer').value = '';
            } else {
                // Mostrar mensaje de error
                document.getElementById('mensajeError').textContent = data.error || 'Ha ocurrido un error al enviar el mensaje. Por favor intenta nuevamente más tarde.';
                document.getElementById('mensajeError').classList.remove('d-none');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('mensajeError').textContent = 'Ha ocurrido un error al procesar tu solicitud. Por favor intenta más tarde.';
            document.getElementById('mensajeError').classList.remove('d-none');
        })
        .finally(() => {
            // Restaurar botón
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        });
    });
    
    // Restablecer estado del captcha cuando se modifica
    document.getElementById('captchaAnswer').addEventListener('input', function() {
        this.classList.remove('is-invalid');
    });
    
    // Manejar el cambio en el selector de asunto
    const asuntoSelect = document.getElementById('asunto');
    const otroAsuntoContainer = document.getElementById('otroAsuntoContainer');
    const otroAsuntoInput = document.getElementById('otroAsunto');
    
    asuntoSelect.addEventListener('change', function() {
        if (this.value === 'Otro') {
            otroAsuntoContainer.style.display = 'block';
            otroAsuntoInput.setAttribute('required', true);
        } else {
            otroAsuntoContainer.style.display = 'none';
            otroAsuntoInput.removeAttribute('required');
        }
    });
    
    // Preseleccionar asunto cuando se hace clic en la información de código promocional
    document.querySelector('.alert-info').addEventListener('click', function() {
        asuntoSelect.value = 'Solicitud de código promocional';
        // Disparar el evento change para actualizar cualquier lógica dependiente
        const event = new Event('change');
        asuntoSelect.dispatchEvent(event);
    });
});
</script>
{% endblock %} 